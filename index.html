<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>タックスナップ アンケート</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#ecfdf5',
              100: '#d1fae5',
              200: '#a7f3d0',
              300: '#6ee7b7',
              400: '#34d399',
              500: '#10b981',
              600: '#059669',
              700: '#047857',
              800: '#065f46',
              900: '#064e3b',
            }
          }
        }
      }
    }
  </script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; }

    .step { display: none; opacity: 0; transform: translateX(40px); }
    .step.active { display: block; animation: slideIn 0.35s ease forwards; }
    .step.exit { display: block; animation: slideOut 0.25s ease forwards; }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(40px); }
      to   { opacity: 1; transform: translateX(0); }
    }
    @keyframes slideOut {
      from { opacity: 1; transform: translateX(0); }
      to   { opacity: 0; transform: translateX(-40px); }
    }

    .feedback-card {
      opacity: 0; transform: translateY(12px);
      animation: fadeUp 0.4s ease 0.15s forwards;
    }
    @keyframes fadeUp {
      to { opacity: 1; transform: translateY(0); }
    }

    .opt-btn {
      transition: all 0.15s ease;
      border: 2px solid #e5e7eb;
    }
    .opt-btn:hover { border-color: #10b981; background: #ecfdf5; }
    .opt-btn.selected {
      border-color: #059669; background: #d1fae5; color: #065f46;
    }
    .opt-btn.selected .check-icon { display: inline-flex; }
    .check-icon { display: none; }

    .progress-fill { transition: width 0.4s ease; }

    .education-card {
      opacity: 0; transform: scale(0.95);
      animation: popIn 0.4s ease 0.1s forwards;
    }
    @keyframes popIn {
      to { opacity: 1; transform: scale(1); }
    }

    .incentive-highlight {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border: 2px solid #f59e0b;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- Header -->
  <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
    <div class="max-w-md mx-auto px-4 py-3 flex items-center justify-between">
      <span class="text-brand-600 font-bold text-lg">タックスナップ</span>
      <span id="stepLabel" class="text-sm text-gray-400"></span>
    </div>
    <div class="h-1 bg-gray-100">
      <div id="progressBar" class="progress-fill h-full bg-brand-500" style="width:0%"></div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-md mx-auto px-4 pt-8 pb-24">

    <!-- ========== INTRO ========== -->
    <div id="intro" class="step active">
      <div class="text-center mb-8">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-brand-100 rounded-full mb-4">
          <svg class="w-8 h-8 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
        </div>
        <h1 class="text-2xl font-bold text-gray-900 mb-2">2分で完了するアンケート</h1>
        <p class="text-gray-500 text-sm leading-relaxed mb-4">
          タックスナップをもっと良くするため<br>率直なご意見を聞かせてください
        </p>
      </div>

      <!-- Incentive -->
      <div class="mb-8">
        <div class="incentive-highlight rounded-xl p-4">
          <div class="flex items-center gap-3">
            <span class="text-2xl">🎁</span>
            <div>
              <p class="text-sm font-bold text-amber-900">回答者の中から抽選で30名様に</p>
              <p class="text-xs text-amber-800 font-semibold">Amazonギフト券1,000円分をプレゼント</p>
            </div>
          </div>
        </div>
      </div>

      <div class="space-y-3 mb-8">
        <div class="flex items-start gap-3 text-sm text-gray-600">
          <span class="flex-shrink-0 w-6 h-6 bg-brand-100 text-brand-700 rounded-full flex items-center justify-center text-xs font-bold">1</span>
          <span>かんたんな質問に答えるだけ（2分）</span>
        </div>
        <div class="flex items-start gap-3 text-sm text-gray-600">
          <span class="flex-shrink-0 w-6 h-6 bg-brand-100 text-brand-700 rounded-full flex items-center justify-center text-xs font-bold">2</span>
          <span>あなたに合った情報をその場でお届け</span>
        </div>
        <div class="flex items-start gap-3 text-sm text-gray-600">
          <span class="flex-shrink-0 w-6 h-6 bg-brand-100 text-brand-700 rounded-full flex items-center justify-center text-xs font-bold">3</span>
          <span>抽選でギフト券1,000円分が当たる</span>
        </div>
      </div>

      <button onclick="startSurvey()" class="w-full py-4 bg-brand-600 hover:bg-brand-700 text-white font-bold rounded-xl text-lg transition">
        始める
      </button>
      <p class="text-center text-xs text-gray-400 mt-3">回答は匿名で処理されます</p>
    </div>

    <!-- ========== Q1: 職種 ========== -->
    <div id="q1" class="step">
      <button onclick="goBack()" class="flex items-center gap-1 text-sm text-gray-400 hover:text-gray-600 mb-4 transition">← 戻る</button>
      <h2 class="text-xl font-bold text-gray-900 mb-1">Q1. あなたのお仕事は？</h2>
      <p class="text-sm text-gray-500 mb-6">一つ選んでください</p>

      <div class="space-y-3" id="q1Options">
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="建設・土木・外構" onclick="selectSingle('q1_job', this)">
          <span class="text-xl">🔨</span>
          <span class="flex-1 text-sm font-medium text-gray-700">建設・土木・外構（一人親方）</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="美容・エステ・ネイル" onclick="selectSingle('q1_job', this)">
          <span class="text-xl">💇</span>
          <span class="flex-1 text-sm font-medium text-gray-700">美容師・ネイリスト・エステ</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="配送・ドライバー" onclick="selectSingle('q1_job', this)">
          <span class="text-xl">🚚</span>
          <span class="flex-1 text-sm font-medium text-gray-700">配送・ドライバー（軽貨物・Uber Eats等）</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="IT・Web系" onclick="selectSingle('q1_job', this)">
          <span class="text-xl">💻</span>
          <span class="flex-1 text-sm font-medium text-gray-700">IT・Web系（エンジニア・デザイナー等）</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="物販・せどり" onclick="selectSingle('q1_job', this)">
          <span class="text-xl">📦</span>
          <span class="flex-1 text-sm font-medium text-gray-700">物販・せどり（メルカリ・Amazon等）</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="生活サービス" onclick="selectSingle('q1_job', this)">
          <span class="text-xl">🏠</span>
          <span class="flex-1 text-sm font-medium text-gray-700">生活サービス（クリーニング・整体・修理等）</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="その他" onclick="selectSingle('q1_job', this)">
          <span class="text-xl">📝</span>
          <span class="flex-1 text-sm font-medium text-gray-700">その他</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
      </div>

      <div id="q1OtherInput" class="hidden mt-3">
        <input type="text" id="q1OtherText" placeholder="ご職業を入力してください"
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-sm focus:border-brand-500 focus:outline-none">
      </div>

      <div id="q1Next" class="hidden mt-6">
        <button onclick="goTo('q2')" class="w-full py-3 bg-brand-600 hover:bg-brand-700 text-white font-bold rounded-xl transition">
          次へ
        </button>
      </div>
    </div>

    <!-- ========== Q2: チャネル ========== -->
    <div id="q2" class="step">
      <button onclick="goBack()" class="flex items-center gap-1 text-sm text-gray-400 hover:text-gray-600 mb-4 transition">← 戻る</button>
      <h2 class="text-xl font-bold text-gray-900 mb-1">Q2. タックスナップを何で知りましたか？</h2>
      <p class="text-sm text-gray-500 mb-6">一つ選んでください</p>

      <div class="space-y-3" id="q2Options">
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="テレビCM" onclick="selectSingle('q2_channel', this); showNext('q2Next')">
          <span class="text-xl">📺</span>
          <span class="flex-1 text-sm font-medium text-gray-700">テレビCM</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="ラジオ・radiko・Spotify" onclick="selectSingle('q2_channel', this); showNext('q2Next')">
          <span class="text-xl">📻</span>
          <span class="flex-1 text-sm font-medium text-gray-700">ラジオ・radiko・Spotify</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="電車内広告" onclick="selectSingle('q2_channel', this); showNext('q2Next')">
          <span class="text-xl">🚃</span>
          <span class="flex-1 text-sm font-medium text-gray-700">電車内広告</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="YouTube・TVer" onclick="selectSingle('q2_channel', this); showNext('q2Next')">
          <span class="text-xl">▶️</span>
          <span class="flex-1 text-sm font-medium text-gray-700">YouTube・TVer</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="SNS" onclick="selectSingle('q2_channel', this); showNext('q2Next')">
          <span class="text-xl">📱</span>
          <span class="flex-1 text-sm font-medium text-gray-700">SNS（X・Instagram・Facebook・TikTokなど）</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="ネット検索" onclick="selectSingle('q2_channel', this); showNext('q2Next')">
          <span class="text-xl">🔍</span>
          <span class="flex-1 text-sm font-medium text-gray-700">ネット検索</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="ニュース・記事・ブログ" onclick="selectSingle('q2_channel', this); showNext('q2Next')">
          <span class="text-xl">📰</span>
          <span class="flex-1 text-sm font-medium text-gray-700">ニュース・記事・ブログ</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="知人の紹介" onclick="selectSingle('q2_channel', this); showNext('q2Next')">
          <span class="text-xl">🤝</span>
          <span class="flex-1 text-sm font-medium text-gray-700">知人の紹介</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="その他" onclick="selectSingle('q2_channel', this); showNext('q2Next')">
          <span class="text-xl">📝</span>
          <span class="flex-1 text-sm font-medium text-gray-700">その他</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
      </div>

      <div id="q2Next" class="hidden mt-6">
        <button onclick="goTo('q3')" class="w-full py-3 bg-brand-600 hover:bg-brand-700 text-white font-bold rounded-xl transition">
          次へ
        </button>
      </div>
    </div>

    <!-- ========== Q3: 確定申告の現在地 ========== -->
    <div id="q3" class="step">
      <button onclick="goBack()" class="flex items-center gap-1 text-sm text-gray-400 hover:text-gray-600 mb-4 transition">← 戻る</button>
      <h2 class="text-xl font-bold text-gray-900 mb-1">Q3. 今年の確定申告、どうする予定ですか？</h2>
      <p class="text-sm text-gray-500 mb-6">一つ選んでください</p>

      <div class="space-y-3" id="q3Options">
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="タックスナップでやる予定" onclick="selectSingle('q3_status', this); showNext('q3Next')">
          <span class="text-xl">📱</span>
          <span class="flex-1 text-sm font-medium text-gray-700">タックスナップでやる予定</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="他のツール・サービスで進めている" onclick="selectSingle('q3_status', this); showNext('q3Next')">
          <span class="text-xl">💻</span>
          <span class="flex-1 text-sm font-medium text-gray-700">他のツール・サービスで進めている（freee・マネーフォワード・弥生など）</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="税理士に依頼している・依頼予定" onclick="selectSingle('q3_status', this); showNext('q3Next')">
          <span class="text-xl">👔</span>
          <span class="flex-1 text-sm font-medium text-gray-700">税理士に依頼している・依頼予定</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="紙・e-Taxで自力でやる予定" onclick="selectSingle('q3_status', this); showNext('q3Next')">
          <span class="text-xl">📝</span>
          <span class="flex-1 text-sm font-medium text-gray-700">紙（手書き）やe-Taxで自力でやる予定</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="何でやるかまだ決めていない" onclick="selectSingle('q3_status', this); showNext('q3Next')">
          <span class="text-xl">🤷</span>
          <span class="flex-1 text-sm font-medium text-gray-700">何でやるかまだ決めていない</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="確定申告が必要かわからない・しない予定" onclick="selectSingle('q3_status', this); showNext('q3Next')">
          <span class="text-xl">🤔</span>
          <span class="flex-1 text-sm font-medium text-gray-700">確定申告が必要かわからない・しない予定</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
      </div>

      <div id="q3Next" class="hidden mt-6">
        <button onclick="goTo('q4')" class="w-full py-3 bg-brand-600 hover:bg-brand-700 text-white font-bold rounded-xl transition">
          次へ
        </button>
      </div>
    </div>

    <!-- ========== Q4: 登録モチベーション ========== -->
    <div id="q4" class="step">
      <button onclick="goBack()" class="flex items-center gap-1 text-sm text-gray-400 hover:text-gray-600 mb-4 transition">← 戻る</button>
      <h2 class="text-xl font-bold text-gray-900 mb-1">Q4. タックスナップに登録した理由は？</h2>
      <p class="text-sm text-gray-500 mb-6">一番近いものを一つ選んでください</p>

      <div class="space-y-3" id="q4Options">
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="気になって登録した" onclick="selectSingle('q4_motivation', this); showNext('q4Next')">
          <span class="text-xl">👀</span>
          <span class="flex-1 text-sm font-medium text-gray-700">気になったのでとりあえず登録してみた</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="比較検討で登録した" onclick="selectSingle('q4_motivation', this); showNext('q4Next')">
          <span class="text-xl">⚖️</span>
          <span class="flex-1 text-sm font-medium text-gray-700">他のツールと比較するために登録した</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="試してみたくて登録した" onclick="selectSingle('q4_motivation', this); showNext('q4Next')">
          <span class="text-xl">✨</span>
          <span class="flex-1 text-sm font-medium text-gray-700">良さそうだったので試してみたくて登録した</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="使うつもりで登録した" onclick="selectSingle('q4_motivation', this); showNext('q4Next')">
          <span class="text-xl">💪</span>
          <span class="flex-1 text-sm font-medium text-gray-700">タックスナップで確定申告しようと思って登録した</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
      </div>

      <div id="q4Next" class="hidden mt-6">
        <button onclick="goTo('q5')" class="w-full py-3 bg-brand-600 hover:bg-brand-700 text-white font-bold rounded-xl transition">
          次へ
        </button>
      </div>
    </div>

    <!-- ========== Q5: コアバリア ========== -->
    <div id="q5" class="step">
      <button onclick="goBack()" class="flex items-center gap-1 text-sm text-gray-400 hover:text-gray-600 mb-4 transition">← 戻る</button>
      <h2 class="text-xl font-bold text-gray-900 mb-1">Q5. トライアルをまだ始めていない一番の理由は？</h2>
      <p class="text-sm text-gray-500 mb-6">一番近いものを一つ選んでください</p>

      <div class="space-y-3" id="q5Options">
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="使う予定" onclick="selectBarrier(this)">
          <span class="text-xl">📅</span>
          <span class="flex-1 text-sm font-medium text-gray-700">使う予定だが、まだ確定申告に手をつけていない</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="料金が高い" onclick="selectBarrier(this)">
          <span class="text-xl">💰</span>
          <span class="flex-1 text-sm font-medium text-gray-700">料金が高い・費用が気になる</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="難しそう" onclick="selectBarrier(this)">
          <span class="text-xl">😰</span>
          <span class="flex-1 text-sm font-medium text-gray-700">使い方が難しそう・始めるハードルが高い</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="他ツールの方が良い" onclick="selectBarrier(this)">
          <span class="text-xl">🔄</span>
          <span class="flex-1 text-sm font-medium text-gray-700">今使っている他のツール・税理士の方が良かった（良さそう）</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="始め方がわからない" onclick="selectBarrier(this)">
          <span class="text-xl">❓</span>
          <span class="flex-1 text-sm font-medium text-gray-700">始め方・やり方がわからなかった</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="セキュリティ不安" onclick="selectBarrier(this)">
          <span class="text-xl">🔒</span>
          <span class="flex-1 text-sm font-medium text-gray-700">セキュリティや信頼性が不安だった</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="その他" onclick="selectBarrier(this)">
          <span class="text-xl">📝</span>
          <span class="flex-1 text-sm font-medium text-gray-700">その他</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
      </div>

      <div id="q5OtherInput" class="hidden mt-3">
        <input type="text" id="q5OtherText" placeholder="理由を入力してください"
          class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-sm focus:border-brand-500 focus:outline-none">
      </div>

      <div id="q5Next" class="hidden mt-6">
        <button onclick="goToQ6()" class="w-full py-3 bg-brand-600 hover:bg-brand-700 text-white font-bold rounded-xl transition">
          次へ
        </button>
      </div>
    </div>

    <!-- ========== Q6: バリア別深掘り ========== -->

    <!-- Q6-A: 使う予定（まだ手をつけていない） -->
    <div id="q6-timing" class="step">
      <button onclick="goBack()" class="flex items-center gap-1 text-sm text-gray-400 hover:text-gray-600 mb-4 transition">← 戻る</button>
      <h2 class="text-xl font-bold text-gray-900 mb-1">Q6. いつ頃始める予定ですか？</h2>
      <p class="text-sm text-gray-500 mb-4">一つ選んでください</p>

      <div class="education-card bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6">
        <div class="flex items-start gap-3">
          <span class="text-2xl">📌</span>
          <div>
            <p class="text-sm font-bold text-amber-900 mb-1">確定申告の期限は3月16日</p>
            <p class="text-sm text-amber-800 leading-relaxed">今から始めれば<strong>1日10分の入力でOK</strong>。3月に慌てる必要はありません。</p>
          </div>
        </div>
      </div>

      <div class="space-y-3">
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white" data-value="2月中に始めたい" onclick="selectSingle('q6sub', this); showNext('q6-timingNext')">
          <span class="text-sm font-medium text-gray-700">2月中に始めたい</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white" data-value="3月に入ってから" onclick="selectSingle('q6sub', this); showNext('q6-timingNext')">
          <span class="text-sm font-medium text-gray-700">3月に入ってから</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white" data-value="ギリギリ（3月10日以降）" onclick="selectSingle('q6sub', this); showNext('q6-timingNext')">
          <span class="text-sm font-medium text-gray-700">ギリギリ（3月10日以降）</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white" data-value="まだ決めていない" onclick="selectSingle('q6sub', this); showNext('q6-timingNext')">
          <span class="text-sm font-medium text-gray-700">まだ決めていない</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
      </div>

      <div id="q6-timingNext" class="hidden mt-6">
        <button onclick="goTo('q7')" class="w-full py-3 bg-brand-600 hover:bg-brand-700 text-white font-bold rounded-xl transition">
          次へ
        </button>
      </div>
    </div>

    <!-- Q6-B: 料金が高い -->
    <div id="q6-price" class="step">
      <button onclick="goBack()" class="flex items-center gap-1 text-sm text-gray-400 hover:text-gray-600 mb-4 transition">← 戻る</button>
      <h2 class="text-xl font-bold text-gray-900 mb-1">Q6. 料金について教えてください</h2>
      <p class="text-sm text-gray-500 mb-4">一つ選んでください</p>

      <div class="education-card bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
        <div class="flex items-start gap-3">
          <span class="text-2xl">💡</span>
          <div>
            <p class="text-sm font-bold text-blue-900 mb-1">ご存知でしたか？</p>
            <p class="text-sm text-blue-800 leading-relaxed">タックスナップは<strong>確定申告を提出する直前まで完全無料</strong>です。何枚レシートを撮っても、何ヶ月使っても0円。いつでもキャンセルできます。</p>
          </div>
        </div>
      </div>

      <div class="space-y-3">
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="無料なのを知らなかった" onclick="selectSingle('q6sub', this); showNext('q6-priceNext')">
          <span class="flex-1 text-sm font-medium text-gray-700">知らなかった！無料なら試してみたい</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="有料プランの価格が気になる" onclick="selectSingle('q6sub', this); showNext('q6-priceNext')">
          <span class="flex-1 text-sm font-medium text-gray-700">知っていたが、最終的に有料になるのが気になる</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white flex items-center gap-3" data-value="他と比べて高い" onclick="selectSingle('q6sub', this); showNext('q6-priceNext')">
          <span class="flex-1 text-sm font-medium text-gray-700">他のサービスと比べて割高に感じる</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
      </div>

      <div id="q6-priceNext" class="hidden mt-6">
        <button onclick="goTo('q7')" class="w-full py-3 bg-brand-600 hover:bg-brand-700 text-white font-bold rounded-xl transition">
          次へ
        </button>
      </div>
    </div>

    <!-- Q6-C: 使い方が難しそう -->
    <div id="q6-difficulty" class="step">
      <button onclick="goBack()" class="flex items-center gap-1 text-sm text-gray-400 hover:text-gray-600 mb-4 transition">← 戻る</button>
      <h2 class="text-xl font-bold text-gray-900 mb-1">Q6. どのあたりが難しそうだと感じましたか？</h2>
      <p class="text-sm text-gray-500 mb-4">あてはまるものをすべて選んでください</p>

      <div class="education-card bg-brand-50 border border-brand-200 rounded-xl p-4 mb-6">
        <div class="flex items-start gap-3">
          <span class="text-2xl">📸</span>
          <div>
            <p class="text-sm font-bold text-brand-900 mb-1">会計知識は一切不要です</p>
            <p class="text-sm text-brand-800 leading-relaxed">勘定科目などの専門知識は不要。レシートを撮れば<strong>AIが自動で仕訳</strong>します。わからないことは<strong>24時間AIサポート</strong>に質問OK。有人サポートもあります。</p>
          </div>
        </div>
      </div>

      <div class="space-y-3">
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white" data-value="初期設定・連携" onclick="toggleMulti('q6sub', this); showNext('q6-difficultyNext')">
          <span class="text-sm font-medium text-gray-700">初期設定や銀行連携</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white" data-value="経費・収入の入力" onclick="toggleMulti('q6sub', this); showNext('q6-difficultyNext')">
          <span class="text-sm font-medium text-gray-700">経費や収入の入力方法</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white" data-value="書類の作成" onclick="toggleMulti('q6sub', this); showNext('q6-difficultyNext')">
          <span class="text-sm font-medium text-gray-700">確定申告の書類作成</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white" data-value="専門用語" onclick="toggleMulti('q6sub', this); showNext('q6-difficultyNext')">
          <span class="text-sm font-medium text-gray-700">専門用語が多くてわからない</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white" data-value="何から始めるか不明" onclick="toggleMulti('q6sub', this); showNext('q6-difficultyNext')">
          <span class="text-sm font-medium text-gray-700">そもそも何から始めればいいかわからない</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
      </div>

      <div id="q6-difficultyNext" class="hidden mt-6">
        <button onclick="goTo('q7')" class="w-full py-3 bg-brand-600 hover:bg-brand-700 text-white font-bold rounded-xl transition">
          次へ
        </button>
      </div>
    </div>

    <!-- Q6-D: 他ツール・税理士の方が良い -->
    <div id="q6-competitor" class="step">
      <button onclick="goBack()" class="flex items-center gap-1 text-sm text-gray-400 hover:text-gray-600 mb-4 transition">← 戻る</button>
      <h2 class="text-xl font-bold text-gray-900 mb-1">Q6. 現在お使い（検討中）のサービスは？</h2>
      <p class="text-sm text-gray-500 mb-4">一つ選んでください</p>

      <div class="education-card bg-orange-50 border border-orange-200 rounded-xl p-4 mb-6">
        <div class="flex items-start gap-3">
          <span class="text-2xl">⭐</span>
          <div>
            <p class="text-sm font-bold text-orange-900 mb-1">確定申告アプリNo.1</p>
            <p class="text-sm text-orange-800 leading-relaxed">App Store評価<strong>4.6</strong>。確定申告アプリランキング1位を獲得。<strong>最速1時間</strong>で確定申告が完了します。</p>
          </div>
        </div>
      </div>

      <div class="space-y-3" id="q6CompOptions">
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white" data-value="freee" onclick="selectSingle('q6sub', this); showQ6CompSub()">
          <span class="text-sm font-medium text-gray-700">freee</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white" data-value="マネーフォワード" onclick="selectSingle('q6sub', this); showQ6CompSub()">
          <span class="text-sm font-medium text-gray-700">マネーフォワード</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white" data-value="弥生" onclick="selectSingle('q6sub', this); showQ6CompSub()">
          <span class="text-sm font-medium text-gray-700">弥生（やよいの青色申告など）</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white" data-value="税理士" onclick="selectSingle('q6sub', this); showQ6CompSub()">
          <span class="text-sm font-medium text-gray-700">税理士</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white" data-value="e-Tax" onclick="selectSingle('q6sub', this); showQ6CompSub()">
          <span class="text-sm font-medium text-gray-700">e-Tax（国税庁サイト）</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white" data-value="その他のツール" onclick="selectSingle('q6sub', this); showQ6CompSub()">
          <span class="text-sm font-medium text-gray-700">その他</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
      </div>

      <div id="q6CompSub" class="hidden mt-6">
        <p class="text-sm font-bold text-gray-900 mb-3">タックスナップに乗り換えない理由は？</p>
        <div class="space-y-3" id="q6CompSubOptions">
          <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white" data-value="データ移行が面倒" onclick="selectSingle('q6sub2', this); showNext('q6-competitorNext')">
            <span class="text-sm font-medium text-gray-700">データ移行が面倒そう</span>
            <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
          </button>
          <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white" data-value="今ので満足" onclick="selectSingle('q6sub2', this); showNext('q6-competitorNext')">
            <span class="text-sm font-medium text-gray-700">今のツール・税理士で十分満足している</span>
            <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
          </button>
          <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white" data-value="比較する時間がない" onclick="selectSingle('q6sub2', this); showNext('q6-competitorNext')">
            <span class="text-sm font-medium text-gray-700">比較する時間がない</span>
            <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
          </button>
          <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white" data-value="契約期間が残っている" onclick="selectSingle('q6sub2', this); showNext('q6-competitorNext')">
            <span class="text-sm font-medium text-gray-700">契約期間が残っている</span>
            <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
          </button>
        </div>
      </div>

      <div id="q6-competitorNext" class="hidden mt-6">
        <button onclick="goTo('q7')" class="w-full py-3 bg-brand-600 hover:bg-brand-700 text-white font-bold rounded-xl transition">
          次へ
        </button>
      </div>
    </div>

    <!-- Q6-E: セキュリティ・信頼性が不安 -->
    <div id="q6-security" class="step">
      <button onclick="goBack()" class="flex items-center gap-1 text-sm text-gray-400 hover:text-gray-600 mb-4 transition">← 戻る</button>
      <h2 class="text-xl font-bold text-gray-900 mb-1">Q6. 特にどの点が不安でしたか？</h2>
      <p class="text-sm text-gray-500 mb-4">あてはまるものをすべて選んでください</p>

      <div class="education-card bg-indigo-50 border border-indigo-200 rounded-xl p-4 mb-6">
        <div class="flex items-start gap-3">
          <span class="text-2xl">🔒</span>
          <div>
            <p class="text-sm font-bold text-indigo-900 mb-1">安心してお使いいただけます</p>
            <p class="text-sm text-indigo-800 leading-relaxed"><strong>金融機関レベルの暗号化</strong>でデータを保護。App Store評価<strong>4.6</strong>、確定申告アプリランキング1位。多くの方にご利用いただいています。</p>
          </div>
        </div>
      </div>

      <div class="space-y-3">
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white" data-value="個人情報の取り扱い" onclick="toggleMulti('q6sub', this); showNext('q6-securityNext')">
          <span class="text-sm font-medium text-gray-700">個人情報の取り扱いが不安</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white" data-value="銀行連携の安全性" onclick="toggleMulti('q6sub', this); showNext('q6-securityNext')">
          <span class="text-sm font-medium text-gray-700">銀行口座との連携が怖い</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white" data-value="会社の信頼性" onclick="toggleMulti('q6sub', this); showNext('q6-securityNext')">
          <span class="text-sm font-medium text-gray-700">運営会社の実績や信頼性がわからない</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
        <button class="opt-btn w-full text-left px-4 py-3 rounded-xl bg-white" data-value="データ消失の不安" onclick="toggleMulti('q6sub', this); showNext('q6-securityNext')">
          <span class="text-sm font-medium text-gray-700">入力したデータが消えないか不安</span>
          <span class="check-icon w-5 h-5 bg-brand-600 text-white rounded-full items-center justify-center text-xs">✓</span>
        </button>
      </div>

      <div id="q6-securityNext" class="hidden mt-6">
        <button onclick="goTo('q7')" class="w-full py-3 bg-brand-600 hover:bg-brand-700 text-white font-bold rounded-xl transition">
          次へ
        </button>
      </div>
    </div>

    <!-- Q6-F: 始め方がわからない / その他 -->
    <div id="q6-simple" class="step">
      <button onclick="goBack()" class="flex items-center gap-1 text-sm text-gray-400 hover:text-gray-600 mb-4 transition">← 戻る</button>
      <div class="education-card bg-brand-50 border border-brand-200 rounded-xl p-5 mb-6">
        <div class="flex items-start gap-3">
          <span class="text-2xl">🚀</span>
          <div>
            <p class="text-sm font-bold text-brand-900 mb-2">ここから3分で始められます</p>
            <p class="text-sm text-brand-800 leading-relaxed mb-1">1. アプリを開く</p>
            <p class="text-sm text-brand-800 leading-relaxed mb-1">2. レシートを1枚撮る</p>
            <p class="text-sm text-brand-800 leading-relaxed">3. AIが自動で仕訳完了！</p>
            <p class="text-xs text-brand-600 mt-2">提出直前まで完全無料。初期設定も不要です。</p>
          </div>
        </div>
      </div>

      <button onclick="goTo('q7')" class="w-full py-3 bg-brand-600 hover:bg-brand-700 text-white font-bold rounded-xl transition">
        次へ（最後の質問）
      </button>
    </div>

    <!-- ========== Q7: 自由記述 ========== -->
    <div id="q7" class="step">
      <button onclick="goBack()" class="flex items-center gap-1 text-sm text-gray-400 hover:text-gray-600 mb-4 transition">← 戻る</button>
      <h2 class="text-xl font-bold text-gray-900 mb-1">Q7. 最後に、ご意見があれば教えてください</h2>
      <p class="text-sm text-gray-500 mb-6">任意（スキップOK）</p>

      <textarea id="q7Text" rows="4" placeholder="「これがあったら使いたい」「ここが不安」など、何でもお気軽にどうぞ"
        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-sm focus:border-brand-500 focus:outline-none resize-none"></textarea>

      <button onclick="submitSurvey()" class="w-full mt-6 py-3 bg-brand-600 hover:bg-brand-700 text-white font-bold rounded-xl transition">
        回答を送信する
      </button>
      <button onclick="submitSurvey()" class="w-full mt-3 py-3 bg-gray-200 hover:bg-gray-300 text-gray-600 font-medium rounded-xl transition">
        スキップして送信
      </button>
    </div>

    <!-- ========== COMPLETE ========== -->
    <div id="complete" class="step">
      <div class="text-center mb-6">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-brand-100 rounded-full mb-4">
          <svg class="w-8 h-8 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-900 mb-2">ありがとうございました！</h2>
        <p class="text-sm text-gray-500">ご回答を受け付けました</p>
      </div>

      <!-- Barrier-specific CTA -->
      <div id="completeCta" class="bg-brand-50 border-2 border-brand-300 rounded-xl p-5 mb-4">
        <p class="text-sm font-bold text-brand-900 mb-2" id="completeCtaTitle"></p>
        <p class="text-sm text-brand-800 mb-4 leading-relaxed" id="completeCtaText"></p>
        <div class="flex gap-3">
          <a href="https://apps.apple.com/app/taxnap" target="_blank"
            class="flex-1 py-3 bg-gray-900 text-white text-sm font-bold rounded-lg text-center hover:bg-gray-800 transition">
            App Store
          </a>
          <a href="https://play.google.com/store/apps/details?id=com.taxnap" target="_blank"
            class="flex-1 py-3 bg-brand-600 text-white text-sm font-bold rounded-lg text-center hover:bg-brand-700 transition">
            Google Play
          </a>
        </div>
      </div>

      <!-- Lottery -->
      <div class="incentive-highlight rounded-xl p-4 mb-4">
        <p class="text-sm font-bold text-amber-900">🎁 抽選で30名様にAmazonギフト券1,000円分</p>
        <p class="text-xs text-amber-700 mt-1">※ 当選発表はメール送付をもって代えさせていただきます</p>
      </div>

      <p class="text-center text-xs text-gray-400 mt-6">ご質問は <a href="mailto:support@taxnap.com" class="underline">support@taxnap.com</a> まで</p>
    </div>

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-white/80 flex items-center justify-center z-50">
      <div class="text-center">
        <div class="inline-block w-8 h-8 border-4 border-brand-200 border-t-brand-600 rounded-full animate-spin mb-3"></div>
        <p class="text-sm text-gray-600">送信中...</p>
      </div>
    </div>

  </main>

  <script>
    // ===== Get email from URL param =====
    const urlParams = new URLSearchParams(window.location.search);
    const userEmail = urlParams.get('email') || '';

    // ===== State =====
    const answers = {
      q1_job: '', q2_channel: '', q3_status: '', q4_motivation: '',
      q5_barrier: '', q6sub: '', q6sub2: '', q7_freetext: ''
    };
    let currentStep = 'intro';
    const navHistory = [];

    // ===== GAS Web App URL =====
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbyYhtrw5D_ALyjOz45fXsoJO4BJatrF2sUXKUlexVXfAIRNfWF8wDYhwtfM_wrYihqU/exec';

    // ===== Step navigation =====
    const totalSteps = 7;

    function getStepNumber(stepId) {
      if (stepId === 'intro') return 0;
      if (stepId === 'q1') return 1;
      if (stepId === 'q2') return 2;
      if (stepId === 'q3') return 3;
      if (stepId === 'q4') return 4;
      if (stepId === 'q5') return 5;
      if (stepId.startsWith('q6')) return 6;
      if (stepId === 'q7') return 7;
      if (stepId === 'complete') return 8;
      return 0;
    }

    function goTo(nextId) {
      navHistory.push(currentStep);
      transition(nextId);
    }

    function goBack() {
      if (navHistory.length === 0) return;
      const prevId = navHistory.pop();
      transition(prevId);
    }

    function transition(nextId) {
      const currentEl = document.getElementById(currentStep);
      const nextEl = document.getElementById(nextId);

      currentEl.classList.remove('active');
      currentEl.classList.add('exit');

      setTimeout(() => {
        currentEl.classList.remove('exit');
        nextEl.classList.add('active');
        currentStep = nextId;

        const stepNum = getStepNumber(nextId);
        const progress = Math.min(100, (stepNum / totalSteps) * 100);
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('stepLabel').textContent =
          nextId === 'complete' ? '完了' :
          nextId === 'intro' ? '' :
          Math.min(stepNum, totalSteps) + ' / ' + totalSteps;

        window.scrollTo({ top: 0, behavior: 'smooth' });
      }, 250);
    }

    function startSurvey() { goTo('q1'); }

    // ===== Helpers =====
    function showNext(elementId) {
      document.getElementById(elementId).classList.remove('hidden');
    }

    // ===== Single select =====
    function selectSingle(questionKey, btn) {
      const container = btn.closest('.space-y-3');
      container.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      answers[questionKey] = btn.dataset.value;

      // Q1: show/hide other input + show next
      if (questionKey === 'q1_job') {
        const otherInput = document.getElementById('q1OtherInput');
        if (btn.dataset.value === 'その他') {
          otherInput.classList.remove('hidden');
          document.getElementById('q1OtherText').focus();
        } else {
          otherInput.classList.add('hidden');
        }
        showNext('q1Next');
      }
    }

    // ===== Multi select =====
    function toggleMulti(questionKey, btn) {
      btn.classList.toggle('selected');
      if (!Array.isArray(answers[questionKey])) answers[questionKey] = [];
      answers[questionKey] = [];
      const container = btn.closest('.space-y-3');
      container.querySelectorAll('.opt-btn.selected').forEach(b => {
        answers[questionKey].push(b.dataset.value);
      });
    }

    // ===== Q5: Barrier selection =====
    function selectBarrier(btn) {
      document.querySelectorAll('#q5Options .opt-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      const val = btn.dataset.value;
      answers.q5_barrier = val;

      const otherInput = document.getElementById('q5OtherInput');
      if (val === 'その他') {
        otherInput.classList.remove('hidden');
        document.getElementById('q5OtherText').focus();
      } else {
        otherInput.classList.add('hidden');
      }

      showNext('q5Next');
    }

    // ===== Q5 → Q6 routing =====
    const barrierToQ6 = {
      '使う予定': 'q6-timing',
      '料金が高い': 'q6-price',
      '難しそう': 'q6-difficulty',
      '他ツールの方が良い': 'q6-competitor',
      '始め方がわからない': 'q6-simple',
      'セキュリティ不安': 'q6-security',
      'その他': 'q6-simple',
    };

    function goToQ6() {
      // Handle Q1 other text
      if (answers.q1_job === 'その他') {
        const otherText = document.getElementById('q1OtherText').value.trim();
        if (otherText) answers.q1_job = 'その他: ' + otherText;
      }
      // Handle Q5 other text
      if (answers.q5_barrier === 'その他') {
        const otherText = document.getElementById('q5OtherText').value.trim();
        if (otherText) answers.q5_barrier = 'その他: ' + otherText;
      }
      const key = answers.q5_barrier.startsWith('その他') ? 'その他' : answers.q5_barrier;
      const target = barrierToQ6[key] || 'q6-simple';
      goTo(target);
    }

    // ===== Q6-competitor sub =====
    function showQ6CompSub() {
      document.getElementById('q6CompSub').classList.remove('hidden');
    }

    // ===== Completion screen CTA =====
    const barrierCta = {
      '使う予定': {
        title: '📅 今始めれば、3月に慌てません',
        text: '1日10分、レシートを撮り溜めるだけ。確定申告時期にはもう準備完了です。'
      },
      '料金が高い': {
        title: '💰 提出直前まで完全無料です',
        text: '何枚レシートを撮っても、何ヶ月使っても0円。まずは1枚撮ってみませんか？'
      },
      '難しそう': {
        title: '📸 会計知識ゼロでOK。サポートも充実',
        text: '勘定科目の知識は不要。24時間AIサポート＋有人サポートで安心です。'
      },
      '他ツールの方が良い': {
        title: '⭐ App Store評価4.6・確定申告アプリNo.1',
        text: '最速1時間で確定申告が完了。提出直前まで無料なのでリスクゼロで比較できます。'
      },
      '始め方がわからない': {
        title: '🚀 ここから3分で始められます',
        text: 'アプリを開いてレシートを1枚撮るだけ。初期設定も不要です。'
      },
      'セキュリティ不安': {
        title: '🔒 App Store評価4.6。安心の実績',
        text: '金融機関レベルの暗号化でデータを保護。確定申告アプリNo.1の信頼性です。'
      },
    };

    function updateCompletionScreen() {
      const key = answers.q5_barrier.startsWith('その他') ? '始め方がわからない' : answers.q5_barrier;
      const cta = barrierCta[key] || barrierCta['始め方がわからない'];
      document.getElementById('completeCtaTitle').textContent = cta.title;
      document.getElementById('completeCtaText').textContent = cta.text;
    }

    // ===== Submit =====
    async function submitSurvey() {
      answers.q7_freetext = document.getElementById('q7Text').value.trim();

      const payload = {
        timestamp: new Date().toISOString(),
        email: userEmail,
        q1_job: answers.q1_job,
        q2_channel: answers.q2_channel,
        q3_status: answers.q3_status,
        q4_motivation: answers.q4_motivation,
        q5_barrier: answers.q5_barrier,
        q6_detail: Array.isArray(answers.q6sub) ? answers.q6sub.join(', ') : (answers.q6sub || ''),
        q6_competitor_reason: answers.q6sub2 || '',
        q7_freetext: answers.q7_freetext,
        user_agent: navigator.userAgent
      };

      document.getElementById('loadingOverlay').classList.remove('hidden');

      try {
        if (GAS_URL !== 'YOUR_GAS_WEB_APP_URL_HERE') {
          await fetch(GAS_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
        } else {
          console.log('Survey data (prototype):', payload);
          await new Promise(r => setTimeout(r, 500));
        }
      } catch (e) {
        console.error('Submit error:', e);
      }

      document.getElementById('loadingOverlay').classList.add('hidden');
      updateCompletionScreen();
      goTo('complete');
    }
  </script>

</body>
</html>
